EZ-MAP Guide
============

Connecting to EZ-MAP
#########
To start using the EZ-MAP webapp you should first connect to the robot, see :doc:`../driving/connecting` for details. Note down the robot's IP.

.. note::
    The primary targeted devices are smartphones and tablets since it's easier to follow the robot around with them, however almost all common phones, tablets and laptops should work.

The EZ-MAP interface is available on the webpage:

.. code-block:: bash

    http://<ROBOT-IP>:3000

.. warning::
   If you are connected to the robot using the access point, you will **not** have internet access. Therefore if you are using a device with enabled mobile data transfer, disable it before connecting since the mobile device won't route packets trough the robot by default. To use both the robot and the internet, switch to the local network option. See :doc:`../driving/connecting` for details.

Optional: Add to Home Screen
#########
.. note:: 
    The app can be used straight away, however saving it as a home screen app (See the image below) eliminates certain usage issues, so it is encouraged.

.. note:: 
    A guide for saving as a home screen app will be provided soon.


Initial setup
#########

.. Icons that are used multiple times:

.. |calibration_button| image:: /_static/ez_map/icons/calibrations.svg
   :alt: Image of the EZ-MAP calibration widget icon
   :width: 55px

.. |view_switch_icon| image:: /_static/ez_map/icons/viewswitch_landscape.svg
   :alt: Image of the EZ-MAP view switch widget icon
   :width: 55px

.. |settings_icon| image:: /_static/ez_map/icons/settings.svg
   :alt: Image of the EZ-MAP settings widget icon
   :width: 55px


.. |uninitialized_battery_icon| image:: /_static/ez_map/icons/unknown.svg
   :alt: Image of the uninitialized EZ-MAP battery widget
   :width: 55px

.. |map_management_icon| image:: /_static/ez_map/icons/map_slam.svg
   :alt: Image of the EZ-MAP map manegement icon
   :width: 55px

When the robot first starts you’ll be asked to provide a location and orientation for your sensors. The process can also be skipped by opening and closing the menu once and can later accessed in the calibration menu (|calibration_button|).

.. image:: /_static/ez_map/calibration_and_sensor_setup.jpg
   :alt: Image of calibration page
   :width: 400px

|

This step is absolutely essential to make sure your robot is configured properly.

Menus and actions
#########

The app contains a collection of submenus and actions represented by icons that are described in this section. The icons should always be visible somewhere in the app interface, however their size and location differs depending on the screen orientation. Since the design of EZ-MAP is modular, these can be added or removed, or you can even write your own custom ones.

|view_switch_icon|

Pressing it swaps the app main views, which are by default the camera video stream and the navigation system, showing a map of the robot's surroundings, generated by the LIDAR.

.. image:: /_static/ez_map/icons/100.svg
   :alt: Image of the EZ-MAP battery widget icon
   :width: 55px

Shows the percentage charge of the robot’s battery, when pressed shows a menu with voltage and percentage values. Note that lead acid batteries should not be deep cycled for best longevity (it's also best to keep them in the range of 50-100%, otherwise system issues can occur due to excessive voltage drops).

|calibration_button|

A collection of 3 different setup menus, that allow easy setup of the robot’s lidar, camera and wheels. This should ideally be done before use, to make sure the robot performs as expected.


.. image:: /_static/ez_map/icons/record_off.svg
   :alt: Image of the EZ-MAP record widget icon
   :width: 55px

Opens the menu that lets the user record all of the robot’s current internal data as a rosbag file (with an option for AVI video export) to an external USB drive (if plugged in) or onto the sd card. 


.. image:: /_static/ez_map/icons/photo.svg
   :alt: Image of the EZ-MAP photo widget icon
   :width: 55px

Takes a photo from the video stream and downloads it through the browser to your device directly. Warning, on some browsers it may override the current tab.


.. image:: /_static/ez_map/icons/map_defaults_settings.svg
   :alt: Image of the EZ-MAP map defaults settings widget icon
   :width: 55px

Opens a menu that lets the user set default options for the map on EZ-MAP boot.

|settings_icon|

Opens a menu for all general robot settings: speed limits, control scheme, system power, etc.


.. image:: /_static/ez_map/settings_menu.jpg
   :alt: Image of the EZ-MAP settings menu
   :align: center
   :width: 600px
|

**THE NOTE BELOW HAS TO BE FACT CHECKED!!**

.. note::
   Powering off and rebooting the robot is not instant. After pressing the buttons it will take about a minute to take effect.

|



Remote control
#########
Assuming the camera is connected correctly, one of the main two screens (|view_switch_icon|) should show the video stream from the robot.

The robot can be driven around using the joysticks which show up by default, see :doc:`../driving/ez_map_simple_drive` for details.

.. note::
    You can select alternative control schemes in the settings menu (|settings_icon|).


.. image:: /_static/ez_map/ezmap_video_stream.png
   :alt: Image of the EZ-MAP video stream
   :width: 400px
|

.. note:: 
    If the battery widget appears as gray (|uninitialized_battery_icon|), then the MCB and motor node have not yet connected and you may need to wait a few more seconds until the robot is ready to go. If it persists for longer than a minute or two then it may be an indicator that there’s something wrong with the motor control.


Mapping
#########
To use the start mapping the robot's surroundings, first switch to the navigation view (|view_switch_icon|). The interface shown should look as follows:

.. image:: /_static/ez_map/ezmap_navigation_view.jpg
   :alt: Image of the EZ-MAP navigation view
   :align: center
   :width: 800px
|

.. note::
    If the screen shows a checklist (see image below) instead of the mapped surroundings, give the system a minute to start or move the robot around slightly so the lidar can gather more data for the initial map iteration. If the message persists for longer it’s likely that the system has not received required data for functioning: i.e. the motor node hasn’t started yet (no battery info) or the lidar hasn’t been connected or configured properly. The checklist should give you an idea of what is missing
.. TODO: add some troubleshooting options

.. image:: /_static/ez_map/ezmap_navigation_view_checklist.png
   :alt: Image of the EZ-MAP navigation view checklist
   :width: 400px
|

Map Management
--------
Clicking the map manegement icon(|map_management_icon|) opens a dropdown menu where one can inspect the currently saved maps, select one for loading or launch creation of a new map and subsequently save it. Resetting the map will clear the currently displayed version of the map and does not affect saved maps. It will also place the starting point (coordinate 0,0) to the robot’s current location.

.. image:: /_static/ez_map/map_dropdown.jpg
   :alt: Image of the EZ-MAP map dropdown
   :align: center
   :width: 100px
|


**INCOMING SLAM AND LOCALIZATION MODE EXPLANATION**

**INCOMING EXPLORATION MODE EXPLANATION**

.. image:: /_static/ez_map/map_exploration_mode.jpg
   :alt: Image of the EZ-MAP exploration mode popup
   :align: center
   :width: 800px
|

.. warning::
   Maps are not automatically saved, if you want to save changes make sure you save the map again.

.. note::
   It is possible to switch from the SLAM (mapping) mode to a localization-only mode at any time by clicking the bottom slider. When a saved map is loaded it will automatically go into localization mode, so the map is preserved as-is, however you can switch back to mapping to extend existing maps.

Landmarks
-------
The hybrid particle filter SLAM also supports landmarks as a way to improve localization accuracy. By default, these are set up to be ArUco markers that can be printed out and laid out around in view of the camera. Once located with reasonable accuracy they will be implemented into the map and rendered as shown below.

.. image:: /_static/ez_map/landmark.png
   :alt: Image of the EZ-MAP ArUco marker image
   :width: 100px
|

.. note::
   In order to get the correct positional data it is crucial to set up the camera position. This can be done in the calibration menu (|calibration_button|).
.. Will this be already set up in the images?


Localizing on a loaded map
-------
On loading a new map the robot may not be in the same place as when it was when the map was created. As such it may be shown out of position:

.. image:: /_static/ez_map/unlocalized_map.png
   :alt: Image of a unlocalized EZ-MAP map
   :width: 600px
|

To help the system gain a good starting point you can drag and drop the robot to a new location in a way that the red dots align with the black walls. After the robot is dropped an arrow will appear showing the forward direction. On mobile it requires another tap and drag for rotation, while on desktop you just need to move the mouse and click once.

.. image:: /_static/ez_map/positioning_localization_map.png
   :alt: Image of positioning the robot in EZ-MAP
   :width: 400px
|

Once the red dots vaguely align with the walls you can let go and the system will localize the robot. Once the robot moves a little it should snap to the map and confirm its position.

.. image:: /_static/ez_map/localized_map.png
   :alt: Image of a correctly localized EZ-MAP map
   :width: 600px
|

**VIDEO CONTENT INCOMING**

Routes
######

.. |route_management_icon| image:: /_static/ez_map/icons/routes.png
   :alt: Image of the EZ-MAP route manegement icon
   :width: 55px

.. |route_drive_forward_icon| image:: /_static/ez_map/icons/route_play.svg
   :alt: Image of the EZ-MAP drive forward icon
   :width: 55px

.. |route_drive_backward_icon| image:: /_static/ez_map/icons/route_reverse.svg
   :alt: Image of the EZ-MAP drive backward icon
   :width: 55px

.. |route_drive_stop_icon| image:: /_static/ez_map/icons/route_cancel.svg
   :alt: Image of the EZ-MAP stop icon
   :width: 55px

Clicking the route management icon (|route_management_icon|) opens the route menu window, where routes can be selected, added and deleted.

.. note::
   Routes are automatically saved along with a map, if the map isn’t saved the route changes will be discarded on shutdown. If you are using an existing map, the routes will auto-save to the map location.

.. image:: /_static/ez_map/route_menu.png
   :alt: Image of the EZ-MAP route menu
   :width: 400px
|

Creating a route
--------
Double tapping anywhere on the map allows you to add a new goal or prompt you for creation of the first route. Unselected routes of the same map are drawn as greyed out.

.. image:: /_static/ez_map/route_creation.png
   :alt: Image of the EZ-MAP route creation
   :width: 600px
|

Once a route is created and selected you can double click/tap on the map to add and remove new goals. Double tapping on the line between goals also creates a new goal between them. You can of course also drag goals around to make adjustments.

**VIDEO CONTENT INCOMING**

Robot Movement
-------
When the route is set, press one of the movement buttons to send the robot forward (|route_drive_forward_icon|) or backwards (|route_drive_backward_icon|) (opposite the drawn arrows in the UI) along the specified route.

The robot will then first proceed to the nearest goal and then follow the route onwards to the last point, where it will stop, unless the route is a loop in which case it’ll continue driving until stopped.

If the robot is in motion one of the previous two buttons will change to stop icon (|route_drive_stop_icon|), and pressing it will stop the robot and cancel the route.

**VIDEO CONTENT INCOMING**

Goal Actions
----------
When you have a route set up, the next step is to define actions executed upon reaching a goal. Hold down your mouse/finger on a goal until the Actions menu appears.

.. image:: /_static/ez_map/actions_menu.png
   :alt: Image of the EZ-MAP actions menu
   :width: 400px
|

As the robot arrives at the specified goal it will then check the defined actions and execute them sequentially one after the other:

**VIDEO CONTENT INCOMING**

.. TODO: add an example goal action such as in the old documentation
**EXAMPLE GOAL ACTION INCOMING**

.. note:: 
    The goal will change colour and shape of the node to indicate stored actions:

.. image:: /_static/ez_map/goal_action_node.png
   :alt: Image of a EZ-MAP route that has stored actions
   :width: 400px
|

.. note::
    The command line functionality allows for running custom scripts at specific points in the route or sending data to other parts of the system.

Looping
-----
There are currently two ways to create perpetual driving:

#. Simply moving the first and last goal together (requires a minimum of 3 goals). The route will then turn purple to indicate successful looping.

    .. image:: /_static/ez_map/looped_route.png
       :alt: Image of a looped EZ-MAP route 
       :width: 800px
    |

    .. note::
        As the first and last goal are joined together only the first goal will execute it’s defined actions (as the last goal is never processed).
   
#. Creating so called ping-pong looping, which is to set the first and last goal to trigger the route in opposite ways using actions

    .. image:: /_static/ez_map/ping_pong_looping.png
       :alt: Image of a ping-pong looped EZ-MAP route 
       :align: center
       :width: 800px
    |
    The robot should then drive the route one way, then reverse and return to the start, and continue forward again. By removing the “Forward” action we also get go-and-return behaviour for example. There are further possible combinations by setting the drive commands to other routes, which lets you chain different routes together.


**VIDEO CONTENT INCOMING**

Locking
------
In case of small devices, it may be easier to lock the positions of goals so they are not accidentally moved when setting up actions. The route management menu has an option labelled [🔒 Lock Goal Movement] which will globally lock route editing until you turn it back on.

Initialization Triggers
######


.. |global_triggers_menu_icon| image:: /_static/ez_map/icons/route_trigger.svg
   :alt: Image of the EZ-MAP global route trigger menu icon 
   :width: 55px
|

The global triggers menu (|global_triggers_menu_icon|) lets you set a string of actions that will be executed once the set conditions are met. The actions are much the same as the ones you can set on specific goals, however they will be triggered globally by some sort of event instead of the robot arriving at the goal. The functionality can be enabled or disabled in order to easily set up and reset the cooldown timers of triggers.

.. image:: /_static/ez_map/global_triggers.png
   :alt: Image of the EZ-MAP global triggers menu 
   :width: 400px
|

**INCOMING GLOBAL TRIGGER EXAMPLE IMAGES AND VIDEOS**
